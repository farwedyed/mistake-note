
<!-- 
  FILENAME: index.html 
  FIXES: 
  1. Stale Data Overwrite (Sync Guard)
  2. Typing Interruption (Debounce & Typing Status Check)
  3. Swift Exit Protection (Save on close/tab switch)
  4. Minimizable AI Menu (Persisted state)
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Mistake Note (Farwed Edition)</title>
    <style>
        :root {
            /* Palette */
            --bg-color: #f8fafc;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --card-bg: #ffffff;
            
            --accent: #6366f1;
            --accent-hover: #4f46e5;
            
            --success: #10b981;
            --error: #ef4444;
            
            /* Model Colors */
            --mod-3pro: #7e22ce;   /* Purple */
            --mod-3flash: #ea580c; /* Orange */
            --mod-25pro: #2563eb;  /* Blue */
            --mod-25flash: #059669;/* Emerald */
            --mod-lite: #64748b;   /* Slate */

            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 16px;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            line-height: 1.6;
        }

        /* --- CLOUD AUTH UI --- */
        .auth-container {
            position: absolute;
            top: 20px;
            right: 20px;
            text-align: right;
            z-index: 100;
        }
        .auth-status-text {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 4px;
            display: block;
        }
        .auth-btn {
            background: var(--text-primary);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.85rem;
            box-shadow: var(--shadow-md);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .auth-btn:hover { background: #0f172a; }
        .auth-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: var(--shadow-md);
            width: 180px;
            margin-top: 5px;
            overflow: hidden;
            flex-direction: column;
        }
        .auth-dropdown.show { display: flex; }
        .dropdown-item {
            padding: 12px 15px;
            background: none;
            border: none;
            text-align: left;
            cursor: pointer;
            font-size: 0.85rem;
            color: var(--text-primary);
            border-bottom: 1px solid #f1f5f9;
        }
        .dropdown-item:hover { background: #f8fafc; color: var(--accent); }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(2px);
        }
        .modal-box {
            background: white;
            padding: 30px;
            border-radius: var(--radius);
            width: 300px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            text-align: center;
        }
        .auth-input {
            width: 100%; box-sizing: border-box;
            padding: 12px; margin-bottom: 10px;
            border: 1px solid #cbd5e0; border-radius: 8px;
        }
        .modal-btn-primary {
            width: 100%; padding: 12px; background: var(--accent);
            color: white; border: none; border-radius: 8px;
            font-weight: bold; cursor: pointer; margin-bottom: 10px;
        }

        /* --- LAYOUT --- */
        .app-wrapper {
            display: flex;
            flex-direction: row;
            max-width: 1300px;
            margin: 0 auto;
            padding: 20px;
            padding-top: 60px;
            gap: 30px;
            align-items: flex-start;
        }

        .main-content {
            flex: 2;
            min-width: 0;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            flex: 1;
            background: white;
            padding: 25px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-md);
            position: sticky;
            top: 20px;
            max-width: 350px;
            border: 1px solid #e2e8f0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }

        /* MINIMIZED STATE CSS */
        .sidebar.minimized {
            flex: 0 0 auto; /* Stop it from expanding */
            width: auto;
            max-width: 200px; /* Keep it tight */
        }
        .sidebar.minimized .sidebar-content {
            display: none; /* Hide the descriptions */
        }
        .sidebar.minimized h2 {
            margin-bottom: 0;
            font-size: 1rem;
        }
        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        .sidebar-toggle-btn {
            background: #f1f5f9;
            border: none;
            width: 24px; height: 24px;
            border-radius: 50%;
            color: var(--text-secondary);
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }
        .sidebar-toggle-btn:hover { background: #e2e8f0; color: var(--accent); }

        .sidebar h2 { margin-top: 0; font-size: 1.2rem; color: var(--text-primary); }
        .sidebar p { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 20px; }

        .model-legend-item {
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            border-left: 5px solid #ccc;
            background: #f8fafc;
            transition: transform 0.2s;
        }
        .model-legend-item:hover { transform: translateX(5px); background: #fff; box-shadow: var(--shadow-md); }

        .mod-name { font-weight: 800; font-size: 1rem; display: flex; justify-content: space-between; }
        .mod-trust { font-size: 0.8rem; font-weight: 700; margin-top: 5px; }
        .mod-desc { font-size: 0.8rem; color: #64748b; margin-top: 5px; line-height: 1.4; }
        .mod-intensity { 
            font-size: 0.7rem; 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
            font-weight: 700; 
            margin-top: 8px; 
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            background: rgba(0,0,0,0.05);
        }

        .mod-box-3pro { border-color: var(--mod-3pro); }
        .mod-box-3pro .mod-name { color: var(--mod-3pro); }
        .mod-box-3flash { border-color: var(--mod-3flash); }
        .mod-box-3flash .mod-name { color: var(--mod-3flash); }
        .mod-box-25pro { border-color: var(--mod-25pro); }
        .mod-box-25pro .mod-name { color: var(--mod-25pro); }
        .mod-box-25flash { border-color: var(--mod-25flash); }
        .mod-box-25flash .mod-name { color: var(--mod-25flash); }

        /* --- HEADER & PFP --- */
        header {
            background: var(--card-bg);
            padding: 30px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-md);
            margin-bottom: 30px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }

        .profile-section { margin-bottom: 20px; }
        .pfp-img {
            width: 80px; height: 80px;
            border-radius: 50%;
            border: 3px solid var(--accent);
            box-shadow: 0 4px 6px rgba(99, 102, 241, 0.3);
            transition: transform 0.3s;
        }
        .pfp-img:hover { transform: rotate(10deg) scale(1.1); }
        
        .creator-tag { font-size: 0.9rem; color: var(--text-secondary); margin-top: 5px; }
        .creator-name { 
            font-weight: 800; 
            background: linear-gradient(90deg, var(--accent), #ec4899);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .description-box {
            background: #f1f5f9;
            padding: 15px;
            border-radius: 12px;
            font-size: 0.9rem;
            color: #475569;
            text-align: left;
            margin: 20px 0;
            border-left: 4px solid var(--accent);
        }

        h1 { margin: 10px 0; font-size: 1.8rem; letter-spacing: -0.5px; }
        a { color: var(--accent); font-weight: 600; text-decoration: none; }
        a:hover { text-decoration: underline; }

        .api-input {
            width: 100%; box-sizing: border-box; padding: 12px; border: 2px solid #e2e8f0;
            border-radius: 10px; margin-bottom: 15px; font-size: 0.9rem;
        }

        .file-drop-zone {
            border: 2px dashed #cbd5e0; padding: 30px; border-radius: 12px;
            cursor: pointer; background: #f8fafc; color: var(--text-secondary);
            transition: 0.2s;
        }
        .file-drop-zone:hover { border-color: var(--accent); background: #eef2ff; color: var(--accent); }

        .control-bar { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-bottom: 20px; }
        .action-btn {
            padding: 8px 16px; border: none; border-radius: 20px; cursor: pointer;
            font-weight: 600; font-size: 0.85rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: 0.2s;
        }
        .action-btn:hover { transform: translateY(-2px); }
        .btn-reveal { background: #fbbf24; color: #1e293b; }
        .btn-reset { background: var(--accent); color: white; }
        .btn-clear { background: #e2e8f0; color: #475569; }
        .btn-notes { background: #10b981; color: white; }

        .tabs-nav { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 20px; justify-content: flex-start; scrollbar-width: none; }
        .tab-btn {
            padding: 6px 14px; border-radius: 20px; border: 1px solid transparent;
            background: transparent; color: var(--text-secondary); cursor: pointer; font-weight: 600; font-size: 0.85rem;
            white-space: nowrap;
        }
        .tab-btn.active { background: white; color: var(--accent); border-color: #e2e8f0; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        /* --- CARDS --- */
        .question-card {
            background: white; border-radius: var(--radius); padding: 25px; margin-bottom: 25px;
            box-shadow: var(--shadow-md); position: relative; border: 1px solid #f1f5f9;
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .subject-tag {
            font-size: 0.7rem; font-weight: 800; text-transform: uppercase; color: var(--accent);
            background: #eef2ff; padding: 4px 8px; border-radius: 4px; display: inline-block; margin-bottom: 10px;
        }
        
        .question-text { 
            font-size: 1.1rem; font-weight: 700; color: var(--text-primary); margin-bottom: 15px; 
            white-space: pre-wrap;
        }
        
        /* Formatting classes */
        .fmt-bold { color: var(--accent); font-weight: 800; }
        .fmt-sub { font-size: 0.75em; vertical-align: sub; }
        .fmt-sup { font-size: 0.75em; vertical-align: super; }
        
        /* Badge UI */
        .ai-badge {
            font-size: 0.7rem; padding: 2px 8px; border-radius: 10px; font-weight: 600;
            display: inline-flex; align-items: center; gap: 4px; border: 1px solid rgba(0,0,0,0.1);
            margin-bottom: 15px;
        }
        .ai-badge.gemini-3-pro-preview { background: #f3e8ff; color: var(--mod-3pro); border-color: var(--mod-3pro); }
        .ai-badge.gemini-3-flash-preview { background: #ffedd5; color: var(--mod-3flash); border-color: var(--mod-3flash); }
        .ai-badge.gemini-2\.5-pro { background: #dbeafe; color: var(--mod-25pro); border-color: var(--mod-25pro); }
        .ai-badge.gemini-2\.5-flash { background: #d1fae5; color: var(--mod-25flash); border-color: var(--mod-25flash); }
        .ai-badge.gemini-2\.5-flash-lite { background: #f1f5f9; color: var(--mod-lite); border-color: var(--mod-lite); }

        .options-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 20px; }
        .option-btn {
            padding: 15px; border: 2px solid #f1f5f9; border-radius: 12px; background: white;
            cursor: pointer; text-align: left; transition: 0.2s; color: #334155; position: relative;
        }
        .option-btn:hover:not(.disabled) { border-color: var(--accent); background: #f8fafc; }
        .option-btn.correct { background: var(--success) !important; color: white !important; border-color: var(--success) !important; }
        .option-btn.incorrect { background: var(--error) !important; color: white !important; border-color: var(--error) !important; }

        /* Mistake Badge Logic */
        .mistake-badge {
            position: absolute; top: -8px; right: -8px; background: #ef4444; color: white;
            font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; font-weight: 700;
            display: none; box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);
        }
        .option-btn.show-badge .mistake-badge { display: block; animation: popIn 0.2s; }
        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }

        /* Explanation UI */
        .explain-btn {
            margin-top: 15px; background: linear-gradient(135deg, var(--accent), #818cf8);
            color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;
            font-size: 0.9rem; font-weight: 600; display: block; width: 100%;
        }
        .explanation-box {
            background: #f0f9ff; border-left: 4px solid #38bdf8; padding: 15px;
            margin-top: 15px; border-radius: 8px; font-size: 0.95rem; color: #0f172a;
            display: none; line-height: 1.6;
        }
        .explanation-box.visible { display: block; }
        .explainer-tag { font-size: 0.7rem; text-transform: uppercase; color: #64748b; margin-bottom: 5px; display: block; font-weight: 700; }

        /* NOTES SECTION UI */
        .note-wrapper {
            margin-top: 15px; border-top: 2px dashed #e2e8f0; padding-top: 15px;
            display: none; animation: fadeIn 0.3s;
        }
        .note-wrapper.visible { display: block; }
        .note-label { font-size: 0.8rem; font-weight: 700; color: #64748b; margin-bottom: 5px; display: block; }
        .user-note-input {
            width: 100%; box-sizing: border-box; border: 1px solid #cbd5e0;
            border-radius: 8px; padding: 10px; font-family: inherit;
            resize: vertical; min-height: 80px; background: #fffdf0; color: #475569;
        }

        .pc-only-note {
            display: none;
            background: #fffbeb; border: 1px solid #fcd34d; color: #92400e;
            padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 0.85rem;
            text-align: center; font-weight: 600;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        @media (max-width: 900px) {
            body { padding: 10px; }
            .app-wrapper { flex-direction: column-reverse; padding: 0; padding-top: 60px; gap: 20px; }
            .sidebar { width: 100%; max-width: none; box-sizing: border-box; position: static; }
            .main-content { width: 100%; }
            .question-card { padding: 15px; }
            h1 { font-size: 1.5rem; }
            .pc-only-note { display: block; }
        }
    </style>
</head>
<body class="show-explains">

<!-- CLOUD AUTH COMPONENT -->
<div class="auth-container">
    <small class="auth-status-text" id="backup-text">Want to backup your bank?</small>
    <button class="auth-btn" id="main-auth-btn" onclick="openAuthModal()">
        <span>üîí</span> Log In / Sign Up
    </button>
    <div class="auth-dropdown" id="auth-dropdown">
        <button class="dropdown-item" onclick="forceCloudSync()">‚òÅÔ∏è Sync Now</button>
        <button class="dropdown-item" onclick="downloadBackup()">üíæ Download Backup (.json)</button>
        <button class="dropdown-item" onclick="logOut()">üö™ Log Out</button>
    </div>
</div>

<div class="modal-overlay" id="auth-modal">
    <div class="modal-box">
        <h3>Access your Cloud Bank</h3>
        <p style="font-size:0.8rem; color:#64748b; margin-bottom:20px;">Log in to sync your mistakes across devices.</p>
        <input type="email" id="auth-email" class="auth-input" placeholder="Email">
        <input type="password" id="auth-pass" class="auth-input" placeholder="Password">
        <button class="modal-btn-primary" onclick="handleAuthAction()">Log In / Sign Up</button>
        <button class="modal-btn-secondary" onclick="document.getElementById('auth-modal').style.display='none'" style="background:none; border:none; color:gray; cursor:pointer;">Cancel</button>
        <div id="auth-msg" style="margin-top:10px; font-size:0.8rem;"></div>
    </div>
</div>

<div class="app-wrapper">
    <main class="main-content">
        <div class="pc-only-note">üì± Note: Works best on Laptop/PC.</div>
        <header>
            <div class="profile-section">
                <img src="https://i.postimg.cc/MKthhghq/3e5c53781e906ac48a73ff4b85860368.gif" alt="Farwed" class="pfp-img">
                <div class="creator-tag">Made by <span class="creator-name">Farwed (Mohamed Ashour)</span></div>
            </div>
            <h1>Universal Mistake Note</h1>
            <div class="description-box">
    <b>Why I made this?</b><br>
    Solving problems is the best way to study, but <i>Mistake Analysis</i> is the literal difference between being "average" and hitting that top 1%.
    <br><br>
    Science (specifically <i>Active Recall</i> & <i>Spaced Repetition</i>) proves this is the fastest way to learn, but honestly? I was too lazy to write every mistake down on paper. So I used technology to hack the system baby
    <br><br>
    <b>How to use:</b><br>
    Just plug your ai key ONCE DO NOT WEEB ABOUT IT (SAVES FOREVER), and then upload a screenshot of a question you got wrong. The AI processes it instantly. Then, <b>once a week</b>, come back here to review your personal "Mistake Bank" and use the AI explanation to actually understand the logic behind the solution.
    <br><br>
    <b>Features:</b><br>
    Real Time Cloud Sync so you can switch between laptop and phone without losing a single second, Multi Model AI Cascade that forces 5 different AI brains to compete to solve your question, Automatic Mistake Recognition which flags the specific wrong option you picked in the screenshot so you never make the same error twice, LaTeX Formatting that actually renders complex math equations correctly, and a Focus Mode that hides all your notes and answers so you can properly torture yourself with Active Recall.
</div>
            <a href="https://aistudio.google.com/app/apikey" target="_blank">üîë Get Free Gemini API Key</a>
            <div style="margin: 20px 0;">
                <input type="password" id="apiKey" class="api-input" placeholder="Paste Gemini API Key here" />
                <div class="file-drop-zone" onclick="document.getElementById('fileInput').click()">
                    <div style="font-size: 1.5rem; font-weight:800;">üì∏ Upload Screenshot (Multi)</div>
                    <small>Auto-detects Subject - Select multiple files at once</small>
                    <input type="file" id="fileInput" accept="image/*" multiple style="display: none" onchange="handleImageUpload(this)">
                </div>
            </div>
            <div class="control-bar">
                <button class="action-btn btn-notes" onclick="toggleGlobalNotes()">üìù Toggle Notes</button>
                <button class="action-btn btn-reveal" onclick="revealAll()">üëÅÔ∏è Reveal All</button>
                <button class="action-btn btn-reset" onclick="resetAllProgress()">üîÑ Reset All</button>
                <button class="action-btn btn-clear" onclick="clearStorage()">üóëÔ∏è Clear Local</button>
            </div>
            <div id="loading" style="display:none; color:var(--accent); font-weight:bold; margin-top:10px;">
                üß† AI is analyzing... <span id="loading-model" style="font-weight:normal;"></span>
            </div>
        </header>

        <nav class="tabs-nav">
            <button class="tab-btn active" onclick="setTab('All')">All</button>
            <button class="tab-btn" onclick="setTab('Math')">Math</button>
            <button class="tab-btn" onclick="setTab('Physics')">Physics</button>
            <button class="tab-btn" onclick="setTab('Chemistry')">Chemistry</button>
            <button class="tab-btn" onclick="setTab('Biology')">Biology</button>
            <button class="tab-btn" onclick="setTab('English')">English</button>
            <button class="tab-btn" onclick="setTab('Arabic')">Arabic</button>
        </nav>
        <div id="quiz-area"></div>
    </main>

    <aside class="sidebar" id="mainSidebar">
        <div class="sidebar-header" onclick="toggleSidebar()">
            <h2>ü§ñ AI Brains Menu</h2>
            <button class="sidebar-toggle-btn" id="sb-toggle-icon">‚ûñ</button>
        </div>
        <div class="sidebar-content">
            <p>Know which model you are trusting.</p>
            <div class="model-legend-item mod-box-3pro">
                <div class="mod-name">Gem 3 Pro <span>üíé</span></div>
                <div class="mod-trust" style="color:var(--mod-3pro)">Trust Level: 99%</div>
                <div class="mod-intensity">Very High Intensity</div>
                <div class="mod-desc">The smartest model available. Rely on this for complex Physics or Math logic.</div>
            </div>
            <div class="model-legend-item mod-box-3flash">
                <div class="mod-name">Gem 3 Flash <span>‚ö°</span></div>
                <div class="mod-trust" style="color:var(--mod-3flash)">Trust Level: 95%</div>
                <div class="mod-intensity">High Intensity</div>
                <div class="mod-desc">Very smart and faster. Great for Chemistry and Biology questions.</div>
            </div>
            <div class="model-legend-item mod-box-25pro">
                <div class="mod-name">Gem 2.5 Pro <span>üß†</span></div>
                <div class="mod-trust" style="color:var(--mod-25pro)">Trust Level: 90%</div>
                <div class="mod-intensity">Medium Intensity</div>
                <div class="mod-desc">Solid logic, good for languages and standard academic questions.</div>
            </div>
            <div class="model-legend-item mod-box-25flash">
                <div class="mod-name">Gem 2.5 Flash <span>üöÄ</span></div>
                <div class="mod-trust" style="color:var(--mod-25flash)">Trust Level: 55%</div>
                <div class="mod-intensity">Low Intensity</div>
                <div class="mod-desc">Not that smart. Fast but double-check the answer.</div>
            </div>
        </div>
    </aside>
</div>

<!-- (CONTINUED IN NEXT PART) -->
<!-- FIREBASE REAL-TIME MODULE -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBAgbdW2bORZjvMheUQDDVBdZYmIW-549o",
        authDomain: "mistakebank-49e80.firebaseapp.com",
        projectId: "mistakebank-49e80",
        storageBucket: "mistakebank-49e80.firebasestorage.app",
        messagingSenderId: "45617623402",
        appId: "1:45617623402:web:d3a9b0c0ed476f43113513",
        measurementId: "G-K3WFJM5861"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();
    
    let currentUser = null;
    let unsubscribeCloud = null;
    
    // --- SYNC GUARD ---
    let isCloudInitialized = false;

    const modalBox = document.querySelector('.modal-box');
    const googleBtn = document.createElement('button');
    googleBtn.className = 'modal-btn-primary'; googleBtn.style.background = '#4285F4'; googleBtn.style.marginTop = '10px';
    googleBtn.innerHTML = 'üîµ Sign in with Google';
    googleBtn.onclick = async () => { try { await signInWithPopup(auth, provider); } catch(e) { document.getElementById('auth-msg').innerText = e.message; }};
    modalBox.insertBefore(googleBtn, document.querySelector('.modal-btn-secondary'));

    window.openAuthModal = () => currentUser ? document.getElementById('auth-dropdown').classList.toggle('show') : document.getElementById('auth-modal').style.display = 'flex';
    window.logOut = () => { signOut(auth); location.reload(); };

    window.handleAuthAction = async () => {
        const e = document.getElementById('auth-email').value, p = document.getElementById('auth-pass').value;
        try { await signInWithEmailAndPassword(auth, e, p); } catch { try { await createUserWithEmailAndPassword(auth, e, p); } catch(err) { document.getElementById('auth-msg').innerText = err.message; }}
    };

    onAuthStateChanged(auth, (user) => {
        const btn = document.getElementById('main-auth-btn');
        const txt = document.getElementById('backup-text');
        
        if (user) {
            currentUser = user; 
            document.getElementById('auth-modal').style.display='none';
            btn.innerHTML = `üë§ ${user.displayName || user.email.split('@')[0]}`;
            txt.innerText = "Syncing..."; 
            txt.style.color = "var(--accent)";
            
            isCloudInitialized = false;

            const docRef = doc(db, "mistakeBanks", user.uid);
            unsubscribeCloud = onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const cloudData = JSON.parse(docSnap.data().json);
                    if (JSON.stringify(window.quizData) !== JSON.stringify(cloudData)) {
                        console.log("‚òÅÔ∏è Cloud Update Received");
                        window.updateDataGlobal(cloudData);
                    }
                    isCloudInitialized = true;
                    txt.innerText = "Cloud Sync: LIVE üü¢"; 
                    txt.style.color = "var(--success)";
                } else {
                    isCloudInitialized = true;
                    saveToCloud(); 
                    txt.innerText = "Cloud Sync: LIVE üü¢"; 
                    txt.style.color = "var(--success)";
                }
            });
        } else {
            currentUser = null; 
            isCloudInitialized = false;
            btn.innerHTML = `üîí Log In / Sign Up`;
            txt.innerText = "Want to backup your bank?"; txt.style.color = "var(--text-secondary)";
            if (unsubscribeCloud) unsubscribeCloud();
        }
    });

    window.forceCloudSync = () => saveToCloud(true);
    
    async function saveToCloud(notify = false) {
        if (!currentUser || !window.quizData) return;
        if (!isCloudInitialized) {
            console.warn("üö´ Save blocked: Waiting for Cloud to initialize...");
            return;
        }
        try {
            await setDoc(doc(db, "mistakeBanks", currentUser.uid), { json: JSON.stringify(window.quizData), lastUpdated: new Date() });
            if (notify) alert("Saved to Cloud! ‚òÅÔ∏è");
        } catch(e) { console.error(e); }
    }
    window.triggerCloudSave = () => saveToCloud();
</script>

<!-- MAIN APP LOGIC -->
<script>
    // --- STATE & CONFIG ---
    window.quizData = JSON.parse(localStorage.getItem('universalMistakeData')) || [];
    let quizData = window.quizData; 
    let currentTab = 'All';
    let globalNotesToggleState = false;
    
    // --- TYPING STATE MANAGEMENT ---
    window.isUserTyping = false;
    let debounceTimer = null;

    // --- SIDEBAR STATE MANAGEMENT ---
    function initSidebar() {
        const state = localStorage.getItem('sidebarState');
        const sidebar = document.getElementById('mainSidebar');
        const btn = document.getElementById('sb-toggle-icon');
        
        if (state === 'minimized') {
            sidebar.classList.add('minimized');
            btn.innerText = "‚ûï";
        } else {
            btn.innerText = "‚ûñ";
        }
    }
    
    window.toggleSidebar = () => {
        const sidebar = document.getElementById('mainSidebar');
        const btn = document.getElementById('sb-toggle-icon');
        sidebar.classList.toggle('minimized');
        
        if (sidebar.classList.contains('minimized')) {
            localStorage.setItem('sidebarState', 'minimized');
            btn.innerText = "‚ûï";
        } else {
            localStorage.setItem('sidebarState', 'expanded');
            btn.innerText = "‚ûñ";
        }
    };

    // Initialize sidebar immediately
    initSidebar();

    // Called when Firebase receives new data
    window.updateDataGlobal = (newData) => {
        if (window.isUserTyping) {
            console.log("ü§´ Silent Update (User is typing)...");
            window.quizData = newData;
            quizData = window.quizData;
        } else {
            window.quizData = newData;
            quizData = window.quizData;
            saveData(false);
            render();
        }
    };

    const MODEL_CASCADE = [
        'gemini-3-pro-preview',
        'gemini-3-flash-preview',
        'gemini-2.5-pro',
        'gemini-2.5-flash',
        'gemini-2.5-flash-lite'
    ];

    function formatModelName(m) {
        if(m.includes('gemini-3-pro')) return 'Gem 3 Pro';
        if(m.includes('gemini-3-flash')) return 'Gem 3 Flash';
        if(m.includes('gemini-2.5-pro')) return 'Gem 2.5 Pro';
        if(m.includes('gemini-2.5-flash')) return 'Gem 2.5 Flash';
        return m; 
    }

    function formatText(text) {
        if (!text) return '';
        let cleaned = text
            .replace(/\$\\text\{([^}]+)\}\$/g, '$1')
            .replace(/\\text\{([^}]+)\}/g, '$1')
            .replace(/\$/g, '')
            .replace(/\*\*([^*]+)\*\*/g, '<b class="fmt-bold">$1</b>')
            .replace(/\*([^*]+)\*/g, '<i>$1</i>');
        cleaned = cleaned.replace(/([A-Z][a-z]?)(\d+)/g, '$1<sub class="fmt-sub">$2</sub>');
        cleaned = cleaned.replace(/_(\d+)/g, '<sub class="fmt-sub">$1</sub>');
        cleaned = cleaned.replace(/\^(\d+)/g, '<sup class="fmt-sup">$1</sup>');
        return cleaned;
    }

    const apiKeyInput = document.getElementById('apiKey');
    if (localStorage.getItem('geminiApiKey')) apiKeyInput.value = localStorage.getItem('geminiApiKey');
    apiKeyInput.addEventListener('change', (e) => localStorage.setItem('geminiApiKey', e.target.value));

    async function callGemini(apiKey, payload, index = 0) {
        if (index >= MODEL_CASCADE.length) throw new Error("All models failed.");
        const model = MODEL_CASCADE[index];
        try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
            });
            const data = await res.json();
            if (!res.ok || data.error) return callGemini(apiKey, payload, index + 1);
            return { data, model };
        } catch (err) { return callGemini(apiKey, payload, index + 1); }
    }

    async function handleImageUpload(input) {
        const files = Array.from(input.files), key = apiKeyInput.value.trim();
        if (!key) return alert("API Key Required");
        document.getElementById('loading').style.display = 'block';
        for (let i = 0; i < files.length; i++) {
            document.getElementById('loading-model').innerText = `(${i+1}/${files.length})`;
            try {
                const base64 = await new Promise(r => {
                    const reader = new FileReader(); reader.readAsDataURL(files[i]); reader.onload = () => r(reader.result.split(',')[1]);
                });
                const prompt = `Analyze screenshot. Output JSON: { "subject": "Math|Physics|Chemistry|Biology|English|Arabic", "question": "text", "options": ["A","B","C","D"], "answer": "text", "originalWrong": "text|null" }`;
                const { data, model } = await callGemini(key, { contents: [{ parts: [{ text: prompt }, { inline_data: { mime_type: files[i].type, data: base64 } }] }] });
                const res = JSON.parse(data.candidates[0].content.parts[0].text.replace(/```json|```/g, ''));
                quizData.push({ ...res, solved: false, userSelected: null, modelUsed: model, userNote: "", noteVisible: false });
                saveData(); render();
            } catch (e) { console.error(e); }
        }
        document.getElementById('loading').style.display = 'none'; input.value = '';
    }

    async function explainQuestion(idx) {
        const key = apiKeyInput.value.trim(), item = quizData[idx], btn = document.getElementById(`explain-btn-${idx}`);
        btn.innerText = "Thinking...";
        try {
            const { data, model } = await callGemini(key, { contents: [{ parts: [{ text: `Explain why "${item.answer}" is correct for: ${item.question}` }] }] });
            item.explanation = data.candidates[0].content.parts[0].text; item.explanationModel = model;
            saveData(); render();
        } catch (e) { btn.innerText = "Error Try Again"; }
    }

    function render() {
        if(window.isUserTyping) return;

        const area = document.getElementById('quiz-area'); area.innerHTML = '';
        const filtered = currentTab === 'All' ? quizData : quizData.filter(q => (q.subject || '').toLowerCase().includes(currentTab.toLowerCase()));
        [...filtered].reverse().forEach(item => {
            const i = quizData.indexOf(item);
            const card = document.createElement('div'); card.className = `question-card ${item.solved ? 'solved' : ''}`;
            const modelShort = formatModelName(item.modelUsed || 'Unknown');
            
            let explainHtml = '';
            if(item.explanation) {
                const explainerShort = formatModelName(item.explanationModel || item.modelUsed);
                explainHtml = `<div class="explanation-box visible"><span class="explainer-tag">üß† Logic (${explainerShort})</span>${formatText(item.explanation)}</div>`;
            }

            card.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span class="subject-tag">${item.subject || 'General'}</span>
                    <div>
                        <button class="action-btn btn-clear" title="Toggle Note" onclick="toggleNote(${i})">üìù</button>
                        <button class="action-btn btn-clear" title="Reset" onclick="resetOne(${i})">‚Ü∫</button>
                        <button class="action-btn btn-clear" title="Delete" style="color:red" onclick="remove(${i})">‚úï</button>
                    </div>
                </div>
                <div class="question-text">${formatText(item.question)}</div>
                <div class="ai-badge ${item.modelUsed}">ü§ñ generated by: ${modelShort}</div>
                <div class="options-grid"></div>
                ${!item.explanation ? `<button id="explain-btn-${i}" class="explain-btn" onclick="explainQuestion(${i})">üí° Explain Answer</button>` : explainHtml}
                <div class="note-wrapper ${item.noteVisible ? 'visible' : ''}">
                    <span class="note-label">YOUR NOTES:</span>
                    <textarea class="user-note-input" placeholder="Your notes..." oninput="updateNote(${i}, this.value)">${item.userNote||''}</textarea>
                </div>
            `;

            const grid = card.querySelector('.options-grid');
            item.options.forEach(opt => {
                const btn = document.createElement('button'); btn.className = 'option-btn'; 
                const badge = `<div class="mistake-badge">PREVIOUS MISTAKE</div>`;
                btn.innerHTML = formatText(opt) + (item.originalWrong === opt ? badge : '');
                
                if (item.userSelected === opt) {
                    btn.classList.add(opt === item.answer ? 'correct' : 'incorrect');
                    if (item.originalWrong === opt) btn.classList.add('show-badge');
                }
                if (item.solved && opt === item.answer) btn.classList.add('correct');
                
                btn.onclick = () => { if (!item.solved) { item.userSelected = opt; if (opt === item.answer) item.solved = true; saveData(); render(); }};
                grid.appendChild(btn);
            });
            area.appendChild(card);
        });
    }

    // --- SMARTER NOTE SAVING ---
    function updateNote(i, val) { 
        window.isUserTyping = true;
        quizData[i].userNote = val; 
        if (debounceTimer) clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            forceImmediateSave(); 
        }, 1500);
    }

    function forceImmediateSave() {
        if (debounceTimer) clearTimeout(debounceTimer);
        window.isUserTyping = false; 
        saveData(true); 
        console.log("üíæ Forced Immediate Save");
    }

    document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'hidden') {
            forceImmediateSave();
        }
    });
    
    window.addEventListener('beforeunload', () => {
        forceImmediateSave();
    });
    
    // --- HELPER FUNCTIONS ---
    function toggleNote(i) { quizData[i].noteVisible = !quizData[i].noteVisible; render(); }
    function toggleGlobalNotes() { globalNotesToggleState = !globalNotesToggleState; quizData.forEach(q => q.noteVisible = globalNotesToggleState); render(); }
    function setTab(t) { currentTab = t; document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.innerText === t)); render(); }
    function remove(i) { if (confirm("Delete?")) { quizData.splice(i, 1); saveData(); render(); } }
    function resetOne(i) { quizData[i].solved = false; quizData[i].userSelected = null; saveData(); render(); }
    function revealAll() { if(confirm("Reveal All?")) { quizData.forEach(q => q.solved = true); saveData(); render(); } }
    function resetAllProgress() { if(confirm("Reset All?")) { quizData.forEach(q => { q.solved = false; q.userSelected = null; }); saveData(); render(); }}
    function clearStorage() { if (confirm("Clear local cache?")) { localStorage.clear(); location.reload(); } }
    
    function saveData(syncCloud = true) { 
        window.quizData = quizData; 
        localStorage.setItem('universalMistakeData', JSON.stringify(quizData)); 
        if (syncCloud && window.triggerCloudSave) window.triggerCloudSave(); 
    }
    
    window.downloadBackup = () => {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(quizData));
        const dl = document.createElement('a'); dl.setAttribute("href", dataStr); dl.setAttribute("download", "backup.json"); dl.click();
    };
    
    render();
</script>
</body>
</html>
